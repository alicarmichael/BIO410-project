---
title: "Project"
author: "Vincent Cortes"
date: "2024-11-19"
output: pdf_document
---
```{r load packs}
library(terra)
library(ggplot2)
library(dplyr)
library(sf)
library(maps)
library(ggspatial)
library(plotly)
library(knitr)
library(stringr)
```
Cleaning Oregon Bee Atlas data
```{r}
# Load in Oregon Bee Atlas data

oba <- read.csv("project/data/OBA_2018-2023.csv") 
head(oba)
nrow(oba)
```
Using regular expressions to clean the species column of the OBA dataset.
```{r}
## Remove the special character
oba$Associated.plant <- str_replace_all(oba$Associated.plant, "\x92", "")

# Removing blanks
oba <- oba[oba$Associated.plant != "",]

# Removing "net"
oba$Associated.plant <- str_replace_all(oba$Associated.plant, "net", "")

# Removing yarrow
oba$Associated.plant[oba$Associated.plant == "Yarrow"] <- "Achillea millefollium"

# Removing non plant
oba <- oba[oba$Associated.plant != "Weedy yellow comp.",]

# Removing common names in ()
oba$Associated.plant <- gsub("\\s*\\(.*?\\)", "", oba$Associated.plant)

# Removing weird words
oba$Associated.plant <- str_replace_all(oba$Associated.plant, ",.*$", "")

# Removing space
oba$Associated.plant <- str_replace_all(oba$Associated.plant, "\\s+$", "")

# Removing "sp."
oba$Associated.plant <- str_replace_all(oba$Associated.plant, " sp$", " sp.")

# Removing "or"
oba$Associated.plant <- str_replace_all(oba$Associated.plant, " or .*", "")

# Removing lists
oba <- oba[!grepl(",", oba$Associated.plant),]

head(oba)
```
Creating a function to clean all of the plant data seperating them into Family, Genus, Species,
or Missing/complex. Then update the plant names that are only one word to include "sp." so 
they are all the same. Return the data with the clean and sorted plant names.
```{r}
# Function to process plant data

sort_plant_data <- function(data, column) {
  if (!column %in% names(data)) {
    # stop if the column name is not in the data set
    stop("The columnd does not exist in the data.")
  }
  
  # Create the word count column
  data$Plant.word.count <- sapply(data[[column]], function(x) {
    length(unlist(strsplit(x, " ")))
  })
   # Initialize Plant.resolution column to NA
  data$Plant.resolution <- NA
  
  # Loop through data to build up Plant.resolution column
  for (i in 1:nrow(data)) {
    # Determine the plant name
    plant_name <- data[[column]][i]
    
    # Determine word count for each plant name
    word_count <- length(unlist(strsplit(plant_name, " ")))
    
  if (word_count == 1) {
    if (grepl("aceae$", plant_name)) {
      data$Plant.resolution[i] <- "Family"
    } else {
      data$Plant.resolution[i] <- "Genus"
    }
  } else if (word_count == 2 || word_count == 3) {
    if (grepl("sp\\.$", plant_name)) {
      data$Plant.resolution[i] <- "Genus"
    } else {
      data$Plant.resolution[i] <- "Species"
    }
  } else {
      data$Plant.resolution[i] <- "Missing/complex"
  }
}
  
  # Fix single word plant names to include "sp."
  data[[column]] <- str_replace_all(
    data[[column]],
    pattern = "^([A-Za-z]+)$",
    replacement = "\\1 sp."
  )
  
  # Return the cleaned and sorted data
  return(data)
}

# Call the function on our oba data
oba <- sort_plant_data(oba, "Associated.plant")

# Check the results to make sure the function worked as intended
table(oba$Plant.resolution)
unique(oba$Associated.plant[oba$Plant.resolution == "Genus"])
```

Exploring the bee Genus and Species names
```{r}
head(oba)

#colnames(oba)
#oba$Genus
#oba$Species

oba$GenusSpecies <- paste(oba$Genus, oba$Species)
head(oba)
#oba$GenusSpecies
```
Checking how many NA Values we have in ou Latitude and Longitude column.
```{r}
# Initial check
sum(is.na(oba$Dec..Lat.))
sum(is.na(oba$Dec..Long.))

# Filter out the NA values
oba <- oba %>% 
  filter(!is.na(Dec..Lat.) & !is.na(Dec..Long.))

# Final Check
sum(is.na(oba$Dec..Lat.))
sum(is.na(oba$Dec..Long.))

nrow(oba)
```
Loading in the data, and building a data frame with only the columns we need. I also removed any fires that didnt have any cords, mainly just line 165.
```{r, Oregon Map}
# Load Oregon county map data
oregon_map <- map_data("county", "oregon") %>% 
  select(long, lat, group, id = subregion)  # Correct column name is `region`

```


Plotted the bee observations so we can see what areas arent reached by OBA.
```{r graph bee data}
oba_observations_sf <- st_as_sf(oba, coords = c("Dec..Long.", "Dec..Lat."), crs = 4326)

#st_crs(oba_observations_sf)
#st_crs(oregon_map_sf) == st_crs(oba_observations_sf)

#plot bee observations on to oregon map with fires
ggplot() +
  geom_polygon(data = oregon_map, aes(x = long, y = lat, group = group), 
               fill = "lightgrey", color = "white") +
  geom_sf(data = oba_observations_sf, aes(color ="blue"), size = .1, alpha = 0.9) +
  labs(title = "Bee Species Observations in Oregon",
       x = "Longitude", 
       y = "Latitude") +
  theme_minimal() +
  coord_sf()

```


```{r}
LionsHead_sf <- read_sf("project/data/LionsHead/or4472312167920200817_20200810_20210810_burn_bndy.shp")

BeachieCreek_sf <- read_sf("project/data/BeachieCreek/or4482112218820200816_20200810_20210810_burn_bndy.shp")

Riverside_sf <- read_sf("project/data/Riverside/or4504912206220200908_20190720_20210725_burn_bndy.shp")

# Set a common CRS 
target_crs <- st_crs(4326)

# Transform each fire to the target CRS
LionsHead_sf <- st_transform(LionsHead_sf, target_crs)
BeachieCreek_sf <- st_transform(BeachieCreek_sf, target_crs)
Riverside_sf <- st_transform(Riverside_sf, target_crs)

#check if they match
print(st_crs(LionsHead_sf) == st_crs(BeachieCreek_sf))
print(st_crs(BeachieCreek_sf) == st_crs(Riverside_sf))

oregon_map_sf <- st_as_sf(oregon_map, coords = c("long", "lat"), crs = 4326)

ggplot() +
  geom_polygon(data = oregon_map, aes(x = long, y = lat, group = group), 
               fill = "lightgrey", color = "white") +
  geom_sf(data = LionsHead_sf, color = "Red", alpha = 0.9) +
  geom_sf(data = BeachieCreek_sf, color = "Red", alpha = 0.9) +
  geom_sf(data = Riverside_sf, color = "Red", alpha = 0.9) +
  labs(
    title = "Distribution of Oregon Fires in 2020",
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_minimal() +
  coord_sf()

#Now lets zoom in

# merge all fires into one
fire_combined_bbox <- st_bbox(rbind(LionsHead_sf, BeachieCreek_sf, Riverside_sf))

# Adjust the margins 
fire_combined_bbox <- fire_combined_bbox + c(-0.1, -0.1, 0.1, 0.1)  #(xmin, ymin, xmax, ymax)

ggplot() +
  geom_polygon(data = oregon_map, aes(x = long, y = lat, group = group), 
               fill = "lightgrey", color = "white") +
  geom_sf(data = LionsHead_sf, color = "red", alpha = 0.9) +
  geom_sf(data = BeachieCreek_sf, color = "purple", alpha = 0.9) +
  geom_sf(data = Riverside_sf, color = "yellow", alpha = 0.9) +
  labs(
    title = "Zoomed-In View of Oregon Fires in 2020",
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_minimal() +
  coord_sf(
    xlim = c(fire_combined_bbox["xmin"], fire_combined_bbox["xmax"]),
    ylim = c(fire_combined_bbox["ymin"], fire_combined_bbox["ymax"])
  )
```

```{r}


# Count bee observations per fire
fire_bee_counts <- bee_counts %>%
  group_by(FireName) %>%  # Group by fire name or another identifier
  summarize(BeeCount = n())  # Counts the number of bee observations

#create df
fire_bee_counts_df <- as.data.frame(fire_bee_counts)
head(fire_bee_counts_df)

fire_bee_counts_sf <- st_as_sf(fire_bee_counts_df)

all_fire_boarder <- rbind(LionsHead_sf, BeachieCreek_sf, Riverside_sf)

crs(all_fire_buffer, proj = TRUE) == crs(fire_bee_counts_sf, proj = TRUE)

only_fire_bees <- st_intersection(oba_observations_sf, all_fire_boarder)
head(only_fire_bees)



```

```{r, subset data}

 ggplot() +
  geom_polygon(data = oregon_map, aes(x = long, y = lat, group = group), 
               fill = "lightgrey", color = "white") +
  geom_sf(data = LionsHead_sf, color = "red", alpha = 0.9) +
  geom_sf(data = BeachieCreek_sf, color = "purple", alpha = 0.9) +
  geom_sf(data = Riverside_sf, color = "yellow", alpha = 0.9) +
  geom_sf(data = only_fire_bees, aes(color = "Blue"), size = 1, alpha = 0.9) +
  labs(
    title = "Zoomed-In View of Oregon Fires in 2020",
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_minimal() +
  coord_sf(
    xlim = c(fire_combined_bbox["xmin"], fire_combined_bbox["xmax"]),
    ylim = c(fire_combined_bbox["ymin"], fire_combined_bbox["ymax"])
  )

```