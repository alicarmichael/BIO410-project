---
title: "Project"
author: "Vincent Cortes"
date: "2024-11-19"
output: pdf_document
---
```{r load packs}
library(terra)
library(ggplot2)
library(dplyr)
library(sf)
library(maps)
library(ggspatial)
library(plotly)
library(knitr)
library(stringr)
library(vegan)
library(igraph)
library(networkD3)
```
Cleaning Oregon Bee Atlas data
```{r}
# Load in Oregon Bee Atlas data

oba <- read.csv("project/data/OBA_2018-2023.csv") 
head(oba)
nrow(oba)
```
Using regular expressions to clean the species column of the OBA dataset.
```{r}
## Remove the special character
oba$Associated.plant <- str_replace_all(oba$Associated.plant, "\x92", "")

# Removing blanks
oba <- oba[oba$Associated.plant != "",]

# Removing "net"
oba$Associated.plant <- str_replace_all(oba$Associated.plant, "net", "")

# Removing yarrow
oba$Associated.plant[oba$Associated.plant == "Yarrow"] <- "Achillea millefollium"

# Removing non plant
oba <- oba[oba$Associated.plant != "Weedy yellow comp.",]

# Removing common names in ()
oba$Associated.plant <- gsub("\\s*\\(.*?\\)", "", oba$Associated.plant)

# Removing weird words
oba$Associated.plant <- str_replace_all(oba$Associated.plant, ",.*$", "")

# Removing space
oba$Associated.plant <- str_replace_all(oba$Associated.plant, "\\s+$", "")

# Removing "sp."
oba$Associated.plant <- str_replace_all(oba$Associated.plant, " sp$", " sp.")

# Removing "or"
oba$Associated.plant <- str_replace_all(oba$Associated.plant, " or .*", "")

# Removing lists
oba <- oba[!grepl(",", oba$Associated.plant),]

head(oba)
```
Creating a function to clean all of the plant data seperating them into Family, Genus, Species,
or Missing/complex. Then update the plant names that are only one word to include "sp." so 
they are all the same. Return the data with the clean and sorted plant names.
```{r}
# Function to process plant data

sort_plant_data <- function(data, column) {
  if (!column %in% names(data)) {
    # stop if the column name is not in the data set
    stop("The columnd does not exist in the data.")
  }
  
  # Create the word count column
  data$Plant.word.count <- sapply(data[[column]], function(x) {
    length(unlist(strsplit(x, " ")))
  })
   # Initialize Plant.resolution column to NA
  data$Plant.resolution <- NA
  
  # Loop through data to build up Plant.resolution column
  for (i in 1:nrow(data)) {
    # Determine the plant name
    plant_name <- data[[column]][i]
    
    # Determine word count for each plant name
    word_count <- length(unlist(strsplit(plant_name, " ")))
    
  if (word_count == 1) {
    if (grepl("aceae$", plant_name)) {
      data$Plant.resolution[i] <- "Family"
    } else {
      data$Plant.resolution[i] <- "Genus"
    }
  } else if (word_count == 2 || word_count == 3) {
    if (grepl("sp\\.$", plant_name)) {
      data$Plant.resolution[i] <- "Genus"
    } else {
      data$Plant.resolution[i] <- "Species"
    }
  } else {
      data$Plant.resolution[i] <- "Missing/complex"
  }
}
  
  # Fix single word plant names to include "sp."
  data[[column]] <- str_replace_all(
    data[[column]],
    pattern = "^([A-Za-z]+)$",
    replacement = "\\1 sp."
  )
  
  # Return the cleaned and sorted data
  return(data)
}

# Call the function on our oba data
oba <- sort_plant_data(oba, "Associated.plant")

# Check the results to make sure the function worked as intended
table(oba$Plant.resolution)
unique(oba$Associated.plant[oba$Plant.resolution == "Genus"])
```

Exploring the bee Genus and Species names
```{r}
head(oba)

#colnames(oba)
#oba$Genus
#oba$Species

oba$GenusSpecies <- paste(oba$Genus, oba$Species)
head(oba)
#oba$GenusSpecies
```
Checking how many NA Values we have in ou Latitude and Longitude column.
```{r}
# Initial check
sum(is.na(oba$Dec..Lat.))
sum(is.na(oba$Dec..Long.))

# Filter out the NA values
oba <- oba %>% 
  filter(!is.na(Dec..Lat.) & !is.na(Dec..Long.))

# Final Check
sum(is.na(oba$Dec..Lat.))
sum(is.na(oba$Dec..Long.))

nrow(oba)
```
Loading in the data, and building a data frame with only the columns we need. I also removed any fires that didnt have any cords, mainly just line 165.
```{r, Oregon Map}
# Load Oregon county map data
oregon_map <- map_data("county", "oregon") %>% 
  select(long, lat, group, id = subregion)  # Correct column name is `region`

```


Plotted the bee observations so we can see what areas arent reached by OBA.
```{r graph bee data}
oba_observations_sf <- st_as_sf(oba, coords = c("Dec..Long.", "Dec..Lat."), crs = 4326)

#st_crs(oba_observations_sf)
#st_crs(oregon_map_sf) == st_crs(oba_observations_sf)

#plot bee observations on to oregon map with fires
ggplot() +
  geom_polygon(data = oregon_map, aes(x = long, y = lat, group = group), 
               fill = "lightgrey", color = "white") +
  geom_sf(data = oba_observations_sf, aes(color ="blue"), size = .1, alpha = 0.9) +
  labs(title = "Bee Species Observations in Oregon",
       x = "Longitude", 
       y = "Latitude") +
  theme_minimal() +
  coord_sf()

```


```{r}
LionsHead_sf <- read_sf("project/data/LionsHead/or4472312167920200817_20200810_20210810_burn_bndy.shp")

BeachieCreek_sf <- read_sf("project/data/BeachieCreek/or4482112218820200816_20200810_20210810_burn_bndy.shp")

Riverside_sf <- read_sf("project/data/Riverside/or4504912206220200908_20190720_20210725_burn_bndy.shp")

# Set a common CRS 
target_crs <- st_crs(4326)

# Transform each fire to the target CRS
LionsHead_sf <- st_transform(LionsHead_sf, target_crs)
BeachieCreek_sf <- st_transform(BeachieCreek_sf, target_crs)
Riverside_sf <- st_transform(Riverside_sf, target_crs)

#check if they match
print(st_crs(LionsHead_sf) == st_crs(BeachieCreek_sf))
print(st_crs(BeachieCreek_sf) == st_crs(Riverside_sf))

oregon_map_sf <- st_as_sf(oregon_map, coords = c("long", "lat"), crs = 4326)

ggplot() +
  geom_polygon(data = oregon_map, aes(x = long, y = lat, group = group), 
               fill = "lightgrey", color = "white") +
  geom_sf(data = LionsHead_sf, color = "Red", alpha = 0.9) +
  geom_sf(data = BeachieCreek_sf, color = "Red", alpha = 0.9) +
  geom_sf(data = Riverside_sf, color = "Red", alpha = 0.9) +
  labs(
    title = "Distribution of Oregon Fires in 2020",
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_minimal() +
  coord_sf()

#Now lets zoom in

# merge all fires into one
fire_combined_bbox <- st_bbox(rbind(LionsHead_sf, BeachieCreek_sf, Riverside_sf))

# Adjust the margins 
fire_combined_bbox <- fire_combined_bbox + c(-0.1, -0.1, 0.1, 0.1)  #(xmin, ymin, xmax, ymax)

ggplot() +
  geom_polygon(data = oregon_map, aes(x = long, y = lat, group = group), 
               fill = "lightgrey", color = "white") +
  geom_sf(data = LionsHead_sf, aes(color = "Lions Head"), alpha = 0.9) +
  geom_sf(data = BeachieCreek_sf, aes(color = "Beachie Creek"), alpha = 0.9) +
  geom_sf(data = Riverside_sf, aes(color = "Riverside"), alpha = 0.9) +
  scale_color_manual(
    name = "Fires",
    values = c("Lions Head" = "red", "Beachie Creek" = "purple", "Riverside" = "yellow")
  ) +
  labs(
    title = "Zoomed-In View of Oregon Fires in 2020",
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_minimal() +
  coord_sf(
    xlim = c(fire_combined_bbox["xmin"], fire_combined_bbox["xmax"]),
    ylim = c(fire_combined_bbox["ymin"], fire_combined_bbox["ymax"])
  )
```

```{r}
# Count bee observations per fire
fire_bee_counts <- bee_counts %>%
  group_by(FireName) %>%  # Group by fire name or another identifier
  summarize(BeeCount = n())  # Counts the number of bee observations

#create df
fire_bee_counts_df <- as.data.frame(fire_bee_counts)
head(fire_bee_counts_df)

#convert to sf
fire_bee_counts_sf <- st_as_sf(fire_bee_counts_df)

#Merge all fires into one object
all_fire_boarder <- rbind(LionsHead_sf, BeachieCreek_sf, Riverside_sf)

#Create a subset of obersvations inside the border
only_fire_bees <- st_intersection(oba_observations_sf, all_fire_boarder)
head(only_fire_bees)

only_fire_bees_df <- as.data.frame(only_fire_bees)

#merges genus and species and makes a new column
only_fire_bees_df$GenusSpecies <- paste(only_fire_bees_df$Genus, only_fire_bees_df$Species)
#create a subset
final_oba_df <- only_fire_bees_df %>% select("Year.1", "GenusSpecies","Associated.plant...genus..species", "BurnBndLat", "BurnBndLon",)

final_oba_df


```
```{r, subset data}

 ggplot() +
  geom_polygon(data = oregon_map, aes(x = long, y = lat, group = group), 
               fill = "lightgrey", color = "white") +
  geom_sf(data = LionsHead_sf, aes(color = "Lions Head"), alpha = 0.9) +
  geom_sf(data = BeachieCreek_sf, aes(color = "Beachie Creek"), alpha = 0.9) +
  geom_sf(data = Riverside_sf, aes(color = "Riverside"), alpha = 0.9) +
  geom_sf(data = only_fire_bees, aes(color = "Bee Observation"), size = 1, alpha = 0.9) +
  scale_color_manual(
    name = "Key",
    values = c(
      "Lions Head" = "red",
      "Beachie Creek" = "purple",
      "Riverside" = "Dark Green",
      "Bee Observation" = "blue"
    )
  ) +
  labs(
    title = "Oregon Santiam Fire in 2020",
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_minimal() +
  coord_sf(
    xlim = c(fire_combined_bbox["xmin"], fire_combined_bbox["xmax"]),
    ylim = c(fire_combined_bbox["ymin"], fire_combined_bbox["ymax"])
  )

```

Remove the blanks
```{r}
#removed blanks
final_oba_df <- final_oba_df[final_oba_df$Associated.plant...genus..species != "",]
final_oba_df <- final_oba_df[final_oba_df$GenusSpecies != " ",]
is.na(final_oba_df)
final_oba_df
```
```{r}
## Remove the special character
final_oba_df$Associated.plant...genus..species <- str_replace_all(final_oba_df$Associated.plant...genus..species, "\x92", "")

# Removing blanks
final_oba_df <- final_oba_df[final_oba_df$Associated.plant...genus..species != "",]

# Removing "net"
final_oba_df$Associated.plant...genus..species <- str_replace_all(final_oba_df$Associated.plant...genus..species, "net", "")

# Removing yarrow
final_oba_df$Associated.plant...genus..species[final_oba_df$Associated.plant...genus..species == "Yarrow"] <- "Achillea millefollium"

# Removing non plant
final_oba_df <- final_oba_df[final_oba_df$Associated.plant...genus..species != "Weedy yellow comp.",]

# Removing common names in ()
final_oba_df$Associated.plant...genus..species <- gsub("\\s*\\(.*?\\)", "", final_oba_df$Associated.plant...genus..species)

# Removing weird words
final_oba_df$Associated.plant...genus..species <- str_replace_all(final_oba_df$Associated.plant...genus..species, ",.*$", "")

# Removing space
final_oba_df$Associated.plant...genus..species <- str_replace_all(final_oba_df$Associated.plant...genus..species, "\\s+$", "")

# Removing "sp."
final_oba_df$Associated.plant...genus..species <- str_replace_all(final_oba_df$Associated.plant...genus..species, " sp$", " sp.")

# Removing "or"
final_oba_df$Associated.plant...genus..species <- str_replace_all(final_oba_df$Associated.plant...genus..species, " or .*", "")

# Removing lists
final_oba_df <- final_oba_df[!grepl(",", final_oba_df$Associated.plant...genus..species),]

head(final_oba_df)
```

Cleaning the final_oba_df
```{r}
final_oba_df$Plant.resolution <- NA
final_oba_df$Bee.resolution <- NA

for (i in 1:nrow(final_oba_df)) {
  if (str_count(final_oba_df$Associated.plant...genus..species[i], "\\S+") == 1) {
    final_oba_df$Plant.resolution[i] <- "Genus"
  }
  else {
    final_oba_df$Plant.resolution[i] <- "Species"
  }
}

for (i in 1:nrow(final_oba_df)) {
  if (str_count(final_oba_df$GenusSpecies[i], "\\S+") == 1) {
    final_oba_df$Bee.resolution[i] <- "Genus"
  }
  else {
    final_oba_df$Bee.resolution[i] <- "Species"
  }
}
table(final_oba_df$Bee.resolution)
table(final_oba_df$Plant.resolution)

final_oba_df$Plant.genus <- ifelse(
  final_oba_df$Plant.resolution %in% c("Genus", "Species"),
  word(final_oba_df$Associated.plant...genus..species, 1), NA)

table(final_oba_df$Plant.genus)

final_oba_df$Bee.genus <- ifelse(
  final_oba_df$Bee.resolution %in% c("Genus", "Species") & str_count(final_oba_df$GenusSpecies, "\\S+") > 1, word(final_oba_df$GenusSpecies, 1, 2), NA)

table(final_oba_df$Bee.genus)
```

Drop the NA values
```{r}
final_oba_df <- final_oba_df %>% 
  filter(!is.na(Plant.genus) & !is.na(Bee.genus))

final_oba_df
```

Add the site status column to our final clean data frame
```{r}
# Initialize an empty site status column
final_oba_df$Site.status <- NA

# Loop through the oba data frame
for (i in 1:nrow(final_oba_df)) {
  if (final_oba_df$Year.1[i] <= 2020) {
    final_oba_df$Site.status[i] <- "Before"
  }
  else {
    final_oba_df$Site.status[i] <- "After"
  }
}

head(final_oba_df)
```

Before the fires species interactions network
```{r}
# Filter data for 'before' fire interactions
before_fire_interactions <- final_oba_df[final_oba_df$Site.status == "Before", ]

# Create the nodes
nodes <- data.frame(
  name = unique(c(before_fire_interactions$Bee.genus, before_fire_interactions$Plant.genus))
)

# Create the links
links <- data.frame(
  source = match(before_fire_interactions$Bee.genus, nodes$name) - 1,
  target = match(before_fire_interactions$Plant.genus, nodes$name) - 1,
  value = 1
)

# Aggregate interactions for unique source-target pairs
links <- aggregate(value ~ source + target, data = links, sum)

# Create the Sankey network
library(networkD3)

sankey <- sankeyNetwork(
  Links = links,
  Nodes = nodes,
  Source = "source",
  Target = "target",
  Value = "value",
  NodeID = "name",
  units = "Interactions",
  fontSize = 12,
  nodeWidth = 30
)

# Render the Sankey diagram
sankey
```

```{r}
#richness for bees
Bee.Richness.before <- length(unique(final_oba_df$Bee.genus[final_oba_df$Site.status == "Before"]))
Bee.Richness.after <- length(unique(final_oba_df$Bee.genus[final_oba_df$Site.status == "After"]))
Bee.Richness.change <- Bee.Richness.after - Bee.Richness.before

#richness for plants
Plant.Richness.before <- length(unique(final_oba_df$Plant.genus[final_oba_df$Site.status == "Before"]))
Plant.Richness.after <- length(unique(final_oba_df$Plant.genus[final_oba_df$Site.status == "After"]))
Plant.Richness.change <- Plant.Richness.after - Plant.Richness.before
```
Bee
```{r}
shuffled_status <- sample(final_oba_df$Site.status)
final_oba_df$Shuffled.status <- shuffled_status

null_simulation_bee <- replicate(1000,{
  shuffled_status <- sample(final_oba_df$Site.status)
  Richness.before <- length(unique(final_oba_df$Bee.genus[final_oba_df$shuffled.status == "Before"]))
  Richness.after <- length(unique(final_oba_df$Bee.genus[final_oba_df$shuffled.status == "After"]))
  Richness.after - Richness.before
  
})

observed <- Bee.Richness.change
p_value <- mean(null_simulation  >= observed)
print(p_value)

final_oba_df$Shuffled.status
final_oba_df
```
```{r}
shuffled_status <- sample(final_oba_df$Site.status)
final_oba_df$Shuffled.status <- shuffled_status

null_simulation_plant <- replicate(1000,{
  shuffled_status <- sample(final_oba_df$Site.status)
  Richness.before <- length(unique(final_oba_df$Plant.genus[final_oba_df$shuffled.status == "Before"]))
  Richness.after <- length(unique(final_oba_df$Plant.genus[final_oba_df$shuffled.status == "After"]))
  Richness.after - Richness.before
  
})

observed <- Plant.Richness.change
p_value <- mean(null_simulation  >= observed)
print(p_value)
```
```{r}
# Filter data for 'before' fire interactions
after_fire_interactions <- final_oba_df[final_oba_df$Site.status == "After", ]

# Create the nodes
nodes_after <- data.frame(
  name = unique(c(after_fire_interactions$Bee.genus, after_fire_interactions$Plant.genus))
)

# Create the links
links_after <- data.frame(
  source = match(after_fire_interactions$Bee.genus, nodes_after$name) - 1,
  target = match(after_fire_interactions$Plant.genus, nodes_after$name) - 1,
  value = 1
)

# Aggregate interactions for unique source-target pairs
links_after <- aggregate(value ~ source + target, data = links_after, sum)

# Create the Sankey network
library(networkD3)

sankey <- sankeyNetwork(
  Links = links_after,
  Nodes = nodes_after,
  Source = "source",
  Target = "target",
  Value = "value",
  NodeID = "name",
  units = "Interactions",
  fontSize = 12,
  nodeWidth = 30
)

# Render the Sankey diagram
sankey
```

```{r}
bee_summary_stats_df$Site.status <- factor(bee_summary_stats_df$Site.status, levels = c("Before", "After"))

ggplot(bee_summary_stats_df, aes(x = Site.status, y = Species.richness, fill = Site.status)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) +
  labs(
    title = "Species Richness Before and After Fire",
    x = "Site Status",
    y = "Species Richness"
  ) +
  scale_fill_manual(values = c("orange", "skyblue")) +
  theme_minimal()
```

